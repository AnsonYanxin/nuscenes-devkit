import unittest

import numpy as np

from nuscenes.map_expansion import arcline_path_utils


class TestUtils(unittest.TestCase):

    def test_discretize_straight_lane(self):

        arcline_path = {'start_pose': [343.15693237162304, 1485.4649802730903, 1.8352892614071132],
                        'end_pose': [327.9912041101515, 1541.459806549977, 1.8352899366062896],
                        'shape': 'LSR',
                        'radius': 999.999,
                        'segment_length': [0.0031484789478891007, 58.006617324092126, 0.002473280446518614]}

        discrete_path = arcline_path_utils.discretize(arcline_path, 10)
        answer = np.array([[343.15693237162304, 1485.4649802730903, 1.8352892614071132],
                           [340.62931099820577, 1494.7974513201848, 1.8352924098892096],
                           [338.1016896200044, 1504.1299223659835, 1.8352924098892096],
                           [335.57406824180305, 1513.4623934117822, 1.8352924098892096],
                           [333.04644686360166, 1522.7948644575808, 1.8352924098892096],
                           [330.51882548540027, 1532.1273355033795, 1.8352924098892096],
                           [327.9912041101511, 1541.4598065499777, 1.8352899366062898]])

        np.testing.assert_allclose(answer, discrete_path)

    def test_discretize_curved_lane(self):

        arcline_path = {'start_pose': [276.92552924451655, 1448.3565488884922, -1.158216901147601],
                        'end_pose': [283.2454548012898, 1436.4846007361637, -0.9910488587380067],
                        'shape': 'LSL',
                        'radius': 73.83598247205015,
                        'segment_length': [6.759676952145975e-05, 1.1242826918297433, 12.342949052472209]}

        discrete_path = arcline_path_utils.discretize(arcline_path, 2)
        answer = np.array([[276.92552924451655, 1448.3565488884922, -1.158216901147601],
                           [277.70092350786445, 1446.595835056203, -1.1473872597279815],
                           [278.5141587341294, 1444.852324258413, -1.1213308595629856],
                           [279.3725423832621, 1443.1305928780434, -1.0952744593979897],
                           [280.27549170068244, 1441.4318097943576, -1.0692180592329938],
                           [281.2223936762862, 1439.7571283070754, -1.043161659067998],
                           [282.2126054606158, 1438.1076853534023, -1.0171052589030025],
                           [283.2454548012898, 1436.4846007361634, -0.9910488587380066]])

        np.testing.assert_allclose(answer, discrete_path)

